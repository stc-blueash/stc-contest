<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pumpkin Voting (one vote per user/device)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff8dc; color:#5a3e1b; max-width:900px; margin:1rem auto; padding:1rem; }
    .pumpkin-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:1rem; padding:0; list-style:none; }
    .pumpkin-item { background:#f4e1b6; padding:1rem; border-radius:8px; text-align:center; }
    .pumpkin-number { width:120px;height:120px;border-radius:16px;background:#ffd27a;display:flex;align-items:center;justify-content:center;font-size:64px;font-weight:bold;color:#7a3f00;margin:0 auto .5rem; user-select: none; }
    .pumpkin-name { font-weight:bold;margin-bottom:.5rem; }
    button { background:#d2691e;color:#fff;border:none;padding:.5em 1em;border-radius:6px;cursor:pointer;width:100%;max-width:180px;font-weight:bold; }
    button:disabled { background:#a0522d;cursor:not-allowed; }
    .message { text-align:center;margin-top:1rem;color:#a0522d;font-style:italic; }
  </style>

  <!-- Firebase compat libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <h1 style="text-align:center;">Steelcraft Pumpkin Decoration Contest - 2025</h1>
  <ul id="pumpkinList" class="pumpkin-grid"></ul>
  <div class="message" id="message"></div>

  <script>
    // ----- CONFIG: replace with your Firebase project's config -----
    const firebaseConfig = {
      apiKey: "AIzaSyC4qjwxaFkGBPM7D-tqq2CYZoSv5K4l6fQ",
      authDomain: "stc-contest-api.firebaseapp.com",
      projectId: "stc-contest-api",
      storageBucket: "stc-contest-api.appspot.com",
      messagingSenderId: "506275029353",
      appId: "stc-contest-api"
    };
    // ---------------------------------------------------------------

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Pumpkins array (numbers shown instead of images)
    const pumpkins = [
      { id: 1, name: "Spooky Jack", number: 7 },
      { id: 2, name: "Gourd-geous", number: 4 },
      { id: 3, name: "Pumpkin Spice", number: 9 },
      { id: 4, name: "The Great Pumpkin", number: 2 },
      { id: 5, name: "Add Test", number: 10 }
    ];

    // LocalStorage keys
    const LOCAL_VOTES_KEY = 'pumpkinVotesLocal'; // was used before; keep map for compatibility
    const LOCAL_HAS_VOTED_KEY = 'pumpkinHasVoted'; // store votedPumpkinId or true

    function loadLocalVotesMap() {
      try { return JSON.parse(localStorage.getItem(LOCAL_VOTES_KEY)) || {}; } catch (e) { return {}; }
    }
    function saveLocalVotesMap(map) {
      localStorage.setItem(LOCAL_VOTES_KEY, JSON.stringify(map));
    }
    function loadHasVoted() {
      try { return localStorage.getItem(LOCAL_HAS_VOTED_KEY); } catch (e) { return null; }
    }
    function setHasVoted(pumpkinId) {
      try { localStorage.setItem(LOCAL_HAS_VOTED_KEY, String(pumpkinId)); } catch (e) {}
      // keep per-pumpkin map too (legacy)
      const map = loadLocalVotesMap();
      map[pumpkinId] = true;
      saveLocalVotesMap(map);
    }

    // DOM refs
    const pumpkinList = document.getElementById('pumpkinList');
    const message = document.getElementById('message');

    // Firestore refs
    const pumpkinRef = id => db.collection('pumpkins').doc(String(id));
    // single vote doc per user: votes/{userId}
    const userVoteDocRef = userId => db.collection('votes').doc(String(userId));

    // Auth state
    let currentUser = null;
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        await ensurePumpkinsExist();
        renderPumpkins(); // render once we have auth and ensured pumpkins
        setupRealtimeCounts(); // keep internal cache if desired
      } else {
        auth.signInAnonymously().catch(err => {
          console.error('Anonymous sign-in failed:', err);
          message.textContent = 'Could not sign in anonymously; voting unavailable.';
        });
      }
    });

    // Ensure pumpkin docs exist
    async function ensurePumpkinsExist() {
      const batch = db.batch();
      for (const p of pumpkins) {
        const ref = pumpkinRef(p.id);
        const snap = await ref.get();
        if (!snap.exists) {
          batch.set(ref, { id: p.id, name: p.name, number: p.number, count: 0 });
        }
      }
      try { await batch.commit(); } catch(e){ /* ignore */ }
    }

    // Render UI; disables all buttons if local hasVoted set
    async function renderPumpkins() {
      if (!currentUser) return;
      pumpkinList.innerHTML = '';
      const hasVotedLocal = !!loadHasVoted();
      const localMap = loadLocalVotesMap();

      for (const p of pumpkins) {
        const li = document.createElement('li');
        li.className = 'pumpkin-item';

        const numberDiv = document.createElement('div');
        numberDiv.className = 'pumpkin-number';
        numberDiv.textContent = p.number;

        const nameDiv = document.createElement('div');
        nameDiv.className = 'pumpkin-name';
        nameDiv.textContent = p.name;

        const voteBtn = document.createElement('button');
        voteBtn.textContent = 'Vote';

        if (hasVotedLocal) {
          // device already voted => disable all buttons
          voteBtn.disabled = true;
        } else {
          // check server-side whether this user has already voted (single doc)
          try {
            const voteDoc = await userVoteDocRef(currentUser.uid).get();
            if (voteDoc.exists) {
              // server says user already voted â€” mirror to local and disable
              setHasVoted(voteDoc.data().pumpkinId || true);
              voteBtn.disabled = true;
            } else {
              voteBtn.disabled = false;
            }
          } catch (err) {
            console.error('Error checking user vote doc:', err);
            // On error, keep button enabled (user can try), or you might prefer to disable
            voteBtn.disabled = false;
          }
        }

        voteBtn.addEventListener('click', async () => {
          // If local storage indicated vote already, be safe and prevent
          if (loadHasVoted()) {
            voteBtn.disabled = true;
            message.textContent = 'You have already voted.';
            return;
          }

          // Optimistically disable all buttons on device for UX
          disableAllVoteButtons(true);

          try {
            // transaction: check user vote doc doesn't exist, increment chosen pumpkin count, create user vote doc
            await db.runTransaction(async (t) => {
              const pRef = pumpkinRef(p.id);
              const uRef = userVoteDocRef(currentUser.uid);

              const [pSnap, uSnap] = await Promise.all([t.get(pRef), t.get(uRef)]);
              if (!pSnap.exists) throw new Error('Pumpkin missing on server');
              if (uSnap.exists) throw new Error('User already voted');

              const newCount = (pSnap.data().count || 0) + 1;
              t.update(pRef, { count: newCount });
              t.set(uRef, { pumpkinId: p.id, votedAt: firebase.firestore.FieldValue.serverTimestamp(), userId: currentUser.uid });
            });

            // mark local device as voted for UX
            setHasVoted(p.id);
            message.textContent = `Thanks for voting for "${p.name}"!`;
            // disable all buttons in UI
            disableAllVoteButtons(true);
          } catch (err) {
            console.error('Vote transaction failed:', err);
            // If server says already voted, mirror to local and disable
            if (err.message && err.message.toLowerCase().includes('already voted')) {
              // read server doc to get which pumpkin if available
              try {
                const uDoc = await userVoteDocRef(currentUser.uid).get();
                if (uDoc.exists) {
                  setHasVoted(uDoc.data().pumpkinId || true);
                } else {
                  setHasVoted(true);
                }
              } catch (e2) {
                setHasVoted(true);
              }
              message.textContent = 'You have already voted.';
              disableAllVoteButtons(true);
            } else {
              message.textContent = 'Could not record vote. Please try again.';
              // Allow user to try again locally
              disableAllVoteButtons(false);
            }
          }
        });

        li.appendChild(numberDiv);
        li.appendChild(nameDiv);
        li.appendChild(voteBtn);
        pumpkinList.appendChild(li);
      }
    }

    // Disable/enable all vote buttons in the current DOM
    function disableAllVoteButtons(disabled) {
      const buttons = document.querySelectorAll('.pumpkin-item button');
      buttons.forEach(b => b.disabled = disabled);
    }

    // Optional: realtime listener kept for internal cache/admin use only (not displayed)
    function setupRealtimeCounts() {
      const col = db.collection('pumpkins');
      col.onSnapshot(snapshot => {
        // Intentionally not rendering counts in UI
        // You could keep them in a cache for admin use if needed
      }, err => {
        console.error('Realtime listener error:', err);
      });
    }

    // Start: sign-in if needed
    (async () => {
      if (!auth.currentUser) {
        try { await auth.signInAnonymously(); } catch (e) { console.error('Sign-in error', e); message.textContent = 'Unable to sign in; voting disabled.'; }
      } else {
        currentUser = auth.currentUser;
        await ensurePumpkinsExist();
        renderPumpkins();
        setupRealtimeCounts();
      }
    })();
  </script>
</body>
</html>
