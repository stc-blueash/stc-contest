<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pumpkin Voting (one vote per user/device)</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff8dc; color:#5a3e1b; max-width:900px; margin:1rem auto; padding:1rem; }
    .pumpkin-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:1rem; padding:0; list-style:none; }
    .pumpkin-item { background:#f4e1b6; padding:1rem; border-radius:8px; text-align:center; }
    .pumpkin-thumb { width:120px; height:120px; object-fit:cover; border-radius:16px; display:block; margin:0 auto .4rem; }
    .pumpkin-number { width:120px;height:120px;border-radius:16px;background:#ffd27a;display:flex;align-items:center;justify-content:center;font-size:64px;font-weight:bold;color:#7a3f00;margin:0 auto .4rem; }
    .pumpkin-name { font-weight:bold;margin-bottom:.5rem; }
    button { background:#d2691e;color:#fff;border:none;padding:.5em 1em;border-radius:6px;cursor:pointer;width:100%;max-width:180px;font-weight:bold; }
    button:disabled { background:#a0522d;cursor:not-allowed; }
    .message { text-align:center;margin-bottom:1rem;color:#a0522d;font-style:italic; min-height:1.5em; }
  </style>

  <!-- Firebase compat libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <h1 style="text-align:center;">Steelcraft Pumpkin Decoration Contest - 2025</h1>
  <!-- Message on top for mobile visibility -->
  <div class="message" id="message"></div>
  <ul id="pumpkinList" class="pumpkin-grid"></ul>

  <script>
    // ----- CONFIG: replace with your Firebase project's config -----
    const firebaseConfig = {
       apiKey: "AIzaSyC4qjwxaFkGBPM7D-tqq2CYZoSv5K4l6fQ",
      authDomain: "stc-contest-api.firebaseapp.com",
      projectId: "stc-contest-api",
      storageBucket: "stc-contest-api.appspot.com",
      messagingSenderId: "506275029353",
      appId: "stc-contest-api"
    };
    // ---------------------------------------------------------------

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Pumpkins array (include image file names in same directory as index.html)
    const pumpkins = [
      { id: 1, name: "Pumpkin No 1", number: 1, image: "pumpkin1.jpg" },
      { id: 2, name: "Pumpkin No 2", number: 2, image: "pumpkin2.jpg" },
      { id: 3, name: "Pumpkin No 3", number: 3, image: "pumpkin3.jpg" },
      { id: 4, name: "Pumpkin No 4", number: 4, image: "pumpkin4.jpg" }
    ];

    // LocalStorage keys
    const LOCAL_VOTES_KEY = 'pumpkinVotesLocal';
    const LOCAL_HAS_VOTED_KEY = 'pumpkinHasVoted';

    function loadLocalVotesMap() {
      try { return JSON.parse(localStorage.getItem(LOCAL_VOTES_KEY)) || {}; } catch (e) { return {}; }
    }
    function saveLocalVotesMap(map) {
      localStorage.setItem(LOCAL_VOTES_KEY, JSON.stringify(map));
    }
    function loadHasVoted() {
      try { return localStorage.getItem(LOCAL_HAS_VOTED_KEY); } catch (e) { return null; }
    }
    function setHasVoted(pumpkinId) {
      try { localStorage.setItem(LOCAL_HAS_VOTED_KEY, String(pumpkinId)); } catch (e) {}
      const map = loadLocalVotesMap();
      map[pumpkinId] = true;
      saveLocalVotesMap(map);
    }

    // DOM refs
    const pumpkinList = document.getElementById('pumpkinList');
    const message = document.getElementById('message');

    // Firestore refs
    const pumpkinRef = id => db.collection('pumpkins').doc(String(id));
    const userVoteDocRef = userId => db.collection('votes').doc(String(userId));

    // Auth state
    let currentUser = null;
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        await ensurePumpkinsExist();
        renderPumpkins();
        setupRealtimeCounts();
      } else {
        auth.signInAnonymously().catch(err => {
          console.error('Anonymous sign-in failed:', err);
          message.textContent = 'Could not sign in anonymously; voting unavailable.';
        });
      }
    });

    async function ensurePumpkinsExist() {
      const batch = db.batch();
      for (const p of pumpkins) {
        const ref = pumpkinRef(p.id);
        const snap = await ref.get();
        if (!snap.exists) {
          batch.set(ref, { id: p.id, name: p.name, number: p.number, count: 0 });
        }
      }
      try { await batch.commit(); } catch(e){ /* ignore */ }
    }

    // Render UI; counts are hidden; show image + number
    async function renderPumpkins() {
      if (!currentUser) return;
      pumpkinList.innerHTML = '';

      const hasVotedLocal = !!loadHasVoted();
      const localMap = loadLocalVotesMap();

      for (const p of pumpkins) {
        const li = document.createElement('li');
        li.className = 'pumpkin-item';

        // Image
        const img = document.createElement('img');
        img.src = p.image;
        img.alt = p.name;
        img.className = 'pumpkin-thumb';
        // In case image fails to load, fall back to name/number
        img.onerror = () => {
          img.style.display = 'none';
        };

        // Number badge
        const numberDiv = document.createElement('div');
        numberDiv.className = 'pumpkin-number';
        numberDiv.textContent = p.number;

        const nameDiv = document.createElement('div');
        nameDiv.className = 'pumpkin-name';
        nameDiv.textContent = p.name;

        const voteBtn = document.createElement('button');
        voteBtn.textContent = 'Vote';

        if (hasVotedLocal) {
          voteBtn.disabled = true;
        } else {
          userVoteDocRef(currentUser.uid).get().then(doc => {
            if (doc.exists) {
              voteBtn.disabled = true;
              setHasVoted(doc.data().pumpkinId || true);
            } else {
              voteBtn.disabled = false;
            }
          }).catch(err => {
            console.error('Error checking user vote doc:', err);
            voteBtn.disabled = false;
          });
        }

        voteBtn.addEventListener('click', async () => {
          if (loadHasVoted()) {
            voteBtn.disabled = true;
            message.textContent = 'You have already voted.';
            return;
          }

          // Optimistic UX: disable all
          disableAllVoteButtons(true);
          try {
            await db.runTransaction(async (t) => {
              const pRef = pumpkinRef(p.id);
              const uRef = userVoteDocRef(currentUser.uid);

              const [pSnap, uSnap] = await Promise.all([t.get(pRef), t.get(uRef)]);
              if (!pSnap.exists) throw new Error('Pumpkin missing on server');
              if (uSnap.exists) throw new Error('User already voted');

              const newCount = (pSnap.data().count || 0) + 1;
              t.update(pRef, { count: newCount });
              t.set(uRef, { pumpkinId: p.id, votedAt: firebase.firestore.FieldValue.serverTimestamp(), userId: currentUser.uid });
            });

            setHasVoted(p.id);
            message.textContent = `Thanks for voting for "${p.name}"!`;
            disableAllVoteButtons(true);
          } catch (err) {
            console.error('Vote transaction failed:', err);
            if (err.message && err.message.toLowerCase().includes('already voted')) {
              try {
                const uDoc = await userVoteDocRef(currentUser.uid).get();
                if (uDoc.exists) setHasVoted(uDoc.data().pumpkinId || true);
              } catch (e2) { setHasVoted(true); }
              message.textContent = 'You have already voted.';
              disableAllVoteButtons(true);
            } else {
              message.textContent = 'Could not record vote. Please try again.';
              disableAllVoteButtons(false);
            }
          }
        });

        li.appendChild(img);
        li.appendChild(numberDiv);
        li.appendChild(nameDiv);
        li.appendChild(voteBtn);
        pumpkinList.appendChild(li);
      }
    }

    function disableAllVoteButtons(disabled) {
      const buttons = document.querySelectorAll('.pumpkin-item button');
      buttons.forEach(b => b.disabled = disabled);
    }

    function setupRealtimeCounts() {
      const col = db.collection('pumpkins');
      col.onSnapshot(snapshot => {
        // Counts are hidden; no UI update here
      }, err => {
        console.error('Realtime listener error:', err);
      });
    }

    (async () => {
      if (!auth.currentUser) {
        try { await auth.signInAnonymously(); } catch (e) { console.error('Sign-in error', e); message.textContent = 'Unable to sign in; voting disabled.'; }
      } else {
        currentUser = auth.currentUser;
        await ensurePumpkinsExist();
        renderPumpkins();
        setupRealtimeCounts();
      }
    })();
  </script>
</body>
</html>
